<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skition</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter and Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply Inter font as default, Poppins for Sign Up/In specific elements if preferred */
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: auto; /* Allow vertical scrolling for the entire body */
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        /* Style for the 3D background canvas */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Place it behind all other content */
        }
        /* Simple transition for interactive elements */
        button, a {
            transition: all 0.2s ease-in-out;
        }
        button:hover, a:hover {
            transform: scale(1.05);
        }
        /* Styles for the modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1a1a1a; /* Darker background for the modal */
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        /* Hide the default file input */
        .hidden-file-input {
            display: none;
        }
        /* Style the custom file input label */
        .upload-label {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            height: 100px;
            border: 2px dashed #4A5568; /* gray-600 */
            border-radius: 50%;
            transition: all 0.3s ease;
            overflow: hidden; /* Ensure image fits within circle */
            position: relative; /* For positioning the plus icon */
        }
        .upload-label:hover {
            border-color: #A0AEC0; /* gray-400 */
            background-color: #1A202C; /* gray-900 */
        }
        .plus-icon {
            font-size: 48px;
            color: #A0AEC0; /* gray-400 */
            font-weight: 100;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .profile-photo {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the area, crop if necessary */
            border-radius: 50%;
        }

        /* Simple CSS for fade-in animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 1s ease-out forwards;
        }
        .animate-fade-in-up {
            animation: fadeInUp 1s ease-out 0.5s forwards; /* 0.5s delay */
            opacity: 0; /* Start hidden */
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col">

    <!-- Three.js Background Canvas (for Welcome Page) -->
    <canvas id="bg-canvas"></canvas>

    <!-- Welcome Page -->
    <div id="welcome-page" class="relative flex flex-col items-center justify-center min-h-screen p-6 text-center">
        <!-- Logo/Title -->
        <h1 class="text-7xl md:text-8xl font-extrabold mb-8 animate-fade-in-down">
            Skition
        </h1>
        <!-- Get Started Button -->
        <button class="bg-white text-black font-bold py-3 px-10 text-lg rounded-lg shadow-lg hover:bg-gray-200 focus:outline-none focus:ring-4 focus:ring-gray-300 transform hover:scale-105 transition-all duration-300 animate-fade-in-up" onclick="showPage('signin-page')">
            Get Started
        </button>
    </div>

    <!-- Sign In Page -->
    <div id="signin-page" class="hidden flex items-center justify-center min-h-screen p-6">
        <div class="w-full max-w-sm mx-auto">
            <!-- Logo/Title -->
            <h1 class="text-6xl md:text-7xl font-extrabold text-white text-center mb-12">
                Skition
            </h1>
            <!-- Sign In Form -->
            <form id="signin-form" class="space-y-6" onsubmit="handleSignIn(event)">
                <div class="space-y-4">
                    <div>
                        <label for="signin-phone" class="sr-only">Phone Number</label>
                        <input 
                            type="tel" 
                            name="phone" 
                            id="signin-phone" 
                            placeholder="Phone Number" 
                            required
                            class="w-full px-4 py-3 bg-gray-800 text-white placeholder-gray-400 border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"
                        >
                    </div>
                    <div>
                        <label for="signin-password" class="sr-only">Password</label>
                        <input 
                            type="password" 
                            name="password" 
                            id="signin-password" 
                            placeholder="Password" 
                            required
                            class="w-full px-4 py-3 bg-gray-800 text-white placeholder-gray-400 border-2 border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200"
                        >
                    </div>
                </div>
                <div>
                    <button 
                        type="submit"
                        class="w-full py-3 mt-4 bg-white text-black text-lg font-semibold rounded-lg shadow-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-black focus:ring-white transform hover:-translate-y-1 transition-all duration-200"
                    >
                        Sign In
                    </button>
                </div>
            </form>
            <p id="signin-message" class="mt-4 text-center text-sm text-red-500 hidden"></p>
            <!-- Link to Sign Up Page -->
            <p class="mt-8 text-center text-sm text-gray-500">
                Don't have an account? 
                <a href="#" class="font-medium text-white hover:text-indigo-400 hover:underline" onclick="showPage('signup-page')">
                    Sign Up
                </a>
            </p>
        </div>
    </div>

    <!-- Sign Up Page -->
    <div id="signup-page" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm mx-auto">
            <h1 class="text-6xl font-bold text-white text-center mb-10">
                Skition
            </h1>
            <form id="signup-form" class="space-y-6" onsubmit="handleSignUp(event)">
                <div class="space-y-4">
                    <div>
                        <input 
                            type="tel" 
                            name="phone" 
                            id="signup-phone" 
                            placeholder="Phone Number" 
                            required
                            class="w-full px-4 py-3 bg-gray-800 text-white placeholder-gray-500 border-none rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
                        >
                    </div>
                    <div>
                        <input 
                            type="password" 
                            name="password" 
                            id="signup-password" 
                            placeholder="Password" 
                            required
                            class="w-full px-4 py-3 bg-gray-800 text-white placeholder-gray-500 border-none rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
                        >
                    </div>
                    <div>
                        <input 
                            type="password" 
                            name="confirm_password" 
                            id="signup-confirm-password" 
                            placeholder="Confirm Password" 
                            required
                            class="w-full px-4 py-3 bg-gray-800 text-white placeholder-gray-500 border-none rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
                        >
                    </div>
                </div>
                <div>
                    <button 
                        type="submit"
                        class="w-full py-3 px-4 bg-white text-black font-semibold rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-black focus:ring-white transition-colors"
                    >
                        Sign Up
                    </button>
                </div>
            </form>
            <p id="signup-message" class="mt-4 text-center text-sm text-red-500 hidden"></p>
            <p class="mt-8 text-center text-sm text-gray-400">
                Already have an account? 
                <a href="#" class="font-medium text-white hover:underline" onclick="showPage('signin-page')">
                    Sign In
                </a>
            </p>
        </div>
    </div>

    <!-- Marketplace Page -->
    <div id="marketplace-page" class="hidden flex-grow pb-24 flex flex-col items-center justify-start pt-16 relative">
        <!-- Logout Button -->
        <button class="absolute top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-gray-700 transition-colors z-50" onclick="handleLogout()">
            Logout
        </button>

        <div class="w-full max-w-2xl mx-auto lg:max-w-4xl xl:max-w-7xl lg:border lg:border-gray-700 lg:rounded-2xl lg:p-8">
            <header class="text-center py-6 md:py-8">
                <h1 class="text-2xl md:text-3xl text-gray-400">marketplace</h1>
            </header>
            <main class="px-4 sm:px-6 lg:px-0">
                <div class="space-y-12">
                    <!-- Top Row: Minter's & Purchased -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                        <!-- Minter's Section -->
                        <section>
                            <h2 class="text-3xl sm:text-4xl font-bold mb-4">Minter's</h2>
                            <div id="minters-list" class="space-y-3">
                                <!-- Minter items will be dynamically loaded here -->
                            </div>
                        </section>
                        <!-- Purchased Section -->
                        <section>
                            <h2 class="text-3xl sm:text-4xl font-bold mb-4">Purchased</h2>
                            <div id="purchased-list" class="space-y-3">
                                <!-- Purchased items will be dynamically loaded here -->
                            </div>
                        </section>
                    </div>
                    <!-- Bottom Row: Minted Section -->
                    <section>
                        <h2 class="text-3xl sm:text-4xl font-bold mb-6">Minted</h2>
                        <div id="minted-list" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                            <!-- Minted items will be dynamically loaded here -->
                        </div>
                    </section>
                    ---
                    <!-- New Section: Orders -->
                    <section>
                        <h2 class="text-3xl sm:text-4xl font-bold mb-6">Orders</h2>
                        <!-- Adjusted grid for larger screens to show 3 columns -->
                        <div id="orders-list" class="grid grid-cols-1 gap-y-6 sm:grid-cols-2 lg:grid-cols-3 gap-x-8">
                            <!-- Order items will be dynamically loaded here -->
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" class="hidden relative min-h-screen flex flex-col items-center justify-start pt-16">
        <!-- Logout Button -->
        <button class="absolute top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-gray-700 transition-colors z-50" onclick="handleLogout()">
            Logout
        </button>

        <!-- Adjusted max-w for larger screens -->
        <main class="w-full max-w-md mx-auto lg:max-w-xl bg-black bg-opacity-50 backdrop-blur-sm p-8 rounded-2xl shadow-2xl space-y-6 flex-grow flex flex-col justify-center">
            <div class="flex flex-col items-center space-y-2">
                <label for="profile-photo-upload" class="upload-label">
                    <img id="profile-photo-preview" class="profile-photo hidden" src="" alt="Profile Photo">
                    <span id="profile-photo-plus-icon" class="plus-icon"></span>
                </label>
                <input type="file" id="profile-photo-upload" class="hidden-file-input" accept="image/*">
                <span class="text-sm text-gray-400">upload photo</span>
            </div>
            <form id="mint-skill-form" class="space-y-4" onsubmit="handleMintSkill(event)">
                <input type="text" id="profile-full-name" placeholder="Full Name" class="w-full p-3 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition">
                <input type="tel" id="profile-phone" value="" class="w-full p-3 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition" readonly>
                <input type="email" id="profile-email" placeholder="Email" class="w-full p-3 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition">
                <input type="text" id="profile-skill" placeholder="Skill (e.g., Web Developer)" class="w-full p-3 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition">
                <div class="flex space-x-4">
                    <input type="number" id="profile-skill-price" placeholder="Skill Price" class="w-1/2 p-3 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition">
                    <input type="number" id="profile-skill-hour" placeholder="Skill Hour" class="w-1/2 p-3 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition">
                </div>
                <input type="url" id="profile-portfolio-url" placeholder="Portfolio URL" class="w-full p-3 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition">
                <button type="submit" class="w-full p-4 bg-gray-200 text-black font-bold rounded-md hover:bg-white transition-colors duration-300">
                    Mint Skill
                </button>
            </form>
            <p id="profile-message" class="mt-4 text-center text-sm text-green-500 hidden"></p>
        </main>
    </div>

    <!-- Bottom Navigation -->
    <footer id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 border-t border-gray-700 grid grid-cols-2 text-2xl font-semibold hidden">
        <a href="#" class="flex-1 text-center py-3 text-lg font-semibold text-gray-500 rounded-lg transition-colors" onclick="showPage('marketplace-page')">
            Market
        </a>
        <a href="#" class="flex-1 text-center py-3 text-lg font-semibold bg-gray-200 text-black rounded-lg transition-colors" onclick="showPage('profile-page')">
            Profile
        </a>
    </footer>

    <!-- Buy Payment Modal Structure -->
    <div id="buyModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-center">Complete Your Purchase</h3>
            <div id="paymentDetails" class="mb-6 text-center">
                <p class="text-lg text-gray-300">You are purchasing:</p>
                <p class="text-xl font-semibold text-white"><span id="modalSkill"></span> for $<span id="modalPrice"></span></p>
            </div>
            
            <div id="buyForm">
                <div class="mb-4">
                    <label for="buyerName" class="block text-gray-400 text-sm font-bold mb-2">Your Name:</label>
                    <input type="text" id="buyerName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" placeholder="John Doe">
                </div>
                <div class="mb-4">
                    <label for="buyerEmail" class="block text-gray-400 text-sm font-bold mb-2">Your Email:</label>
                    <input type="email" id="buyerEmail" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" placeholder="john.doe@example.com">
                </div>
                <div class="mb-6">
                    <label for="buyerPhone" class="block text-gray-400 text-sm font-bold mb-2">Your Phone Number:</label>
                    <input type="tel" id="buyerPhone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" placeholder="+2519XXXXXXXX">
                </div>
                <div class="flex justify-between items-center">
                    <button id="buyPayButton" class="bg-white text-black px-6 py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="processBuyPayment()">Pay with Chapa</button>
                    <button class="bg-transparent text-gray-400 px-6 py-2 rounded-md font-semibold border border-gray-700 hover:bg-gray-700 hover:text-white" onclick="closeBuyModal()">Cancel</button>
                </div>
            </div>
            <div id="buyStatus" class="hidden text-center mt-6">
                <p id="buyStatusMessage" class="text-lg font-semibold"></p>
                <button id="closeBuyStatusButton" class="mt-4 bg-white text-black px-6 py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="closeBuyModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Sell Modal Structure -->
    <div id="sellModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-center">List Your Skill for Sale</h3>
            <div id="sellForm">
                <div class="mb-4">
                    <label for="sellSkillName" class="block text-gray-400 text-sm font-bold mb-2">Skill Name:</label>
                    <input type="text" id="sellSkillName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" placeholder="e.g., Video Editing">
                </div>
                <div class="mb-4">
                    <label for="sellPrice" class="block text-gray-400 text-sm font-bold mb-2">Price (in $):</label>
                    <input type="number" id="sellPrice" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" placeholder="e.g., 25">
                </div>
                <div class="mb-6">
                    <label for="sellDescription" class="block text-gray-400 text-sm font-bold mb-2">Description (optional):</label>
                    <textarea id="sellDescription" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" placeholder="Briefly describe your skill and experience."></textarea>
                </div>
                <div class="flex justify-between items-center">
                    <button id="sellSubmitButton" class="bg-white text-black px-6 py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="processSell()">List for Sale</button>
                    <button class="bg-transparent text-gray-400 px-6 py-2 rounded-md font-semibold border border-gray-700 hover:bg-gray-700 hover:text-white" onclick="closeSellModal()">Cancel</button>
                </div>
            </div>
            <div id="sellStatus" class="hidden text-center mt-6">
                <p id="sellStatusMessage" class="text-lg font-semibold"></p>
                <button id="closeSellStatusButton" class="mt-4 bg-white text-black px-6 py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="closeSellModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Order Modal Structure -->
    <div id="orderModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-center">Place a Custom Order</h3>
            <div id="orderForm">
                <div class="mb-4">
                    <label for="orderSkillNeeded" class="block text-gray-400 text-sm font-bold mb-2">Skill Needed:</label>
                    <input type="text" id="orderSkillNeeded" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" readonly>
                </div>
                <div class="mb-4">
                    <label for="orderDesiredPrice" class="block text-gray-400 text-sm font-bold mb-2">Desired Price (in $):</label>
                    <input type="number" id="orderDesiredPrice" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" readonly>
                </div>
                <div class="mb-4">
                    <label for="orderSkillProvider" class="block text-gray-400 text-sm font-bold mb-2">Skill Provider's Name:</label>
                    <input type="text" id="orderSkillProvider" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" readonly>
                </div>
                <div class="mb-6">
                    <label for="orderRequirements" class="block text-gray-400 text-sm font-bold mb-2">Specific Requirements:</label>
                    <textarea id="orderRequirements" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-800 border-gray-700 text-white" placeholder="Describe what you need in detail."></textarea>
                </div>
                <div class="flex justify-between items-center">
                    <button id="orderSubmitButton" class="bg-white text-black px-6 py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="processOrder()">Place Order</button>
                    <button class="bg-transparent text-gray-400 px-6 py-2 rounded-md font-semibold border border-gray-700 hover:bg-gray-700 hover:text-white" onclick="closeOrderModal()">Cancel</button>
                </div>
            </div>
            <div id="orderStatus" class="hidden text-center mt-6">
                <p id="orderStatusMessage" class="text-lg font-semibold"></p>
                <button id="closeOrderStatusButton" class="mt-4 bg-white text-black px-6 py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="closeOrderModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // --- Global Application Data and State ---
        let appData = {
            users: [],
            marketplace: {
                minters: [], // Skills available for purchase
                purchased: [], // Skills current user has bought
                minted: [], // Skills current user has listed/minted
                orders: [] // Orders received by the current user (for their minted skills)
            }
        };

        let currentUserPhone = null; // Stores the phone number of the currently logged-in user

        const PAGES = ['welcome-page', 'signin-page', 'signup-page', 'marketplace-page', 'profile-page'];

        // --- DOM Elements ---
        const welcomePage = document.getElementById('welcome-page');
        const signInPage = document.getElementById('signin-page');
        const signUpPage = document.getElementById('signup-page');
        const marketplacePage = document.getElementById('marketplace-page');
        const profilePage = document.getElementById('profile-page');
        const bottomNav = document.getElementById('bottom-nav');
        const bgCanvas = document.getElementById('bg-canvas');

        // Sign In Elements
        const signInPhoneInput = document.getElementById('signin-phone');
        const signInPasswordInput = document.getElementById('signin-password');
        const signInMessage = document.getElementById('signin-message');

        // Sign Up Elements
        const signUpPhoneInput = document.getElementById('signup-phone');
        const signUpPasswordInput = document.getElementById('signup-password');
        const signUpConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const signUpMessage = document.getElementById('signup-message');

        // Marketplace List Elements
        const mintersList = document.getElementById('minters-list');
        const purchasedList = document.getElementById('purchased-list');
        const mintedList = document.getElementById('minted-list');
        const ordersList = document.getElementById('orders-list');

        // Profile Elements
        const profileFullNameInput = document.getElementById('profile-full-name');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profileEmailInput = document.getElementById('profile-email');
        const profileSkillInput = document.getElementById('profile-skill');
        const profileSkillPriceInput = document.getElementById('profile-skill-price');
        const profileSkillHourInput = document.getElementById('profile-skill-hour');
        const profilePortfolioUrlInput = document.getElementById('profile-portfolio-url');
        const profileMessage = document.getElementById('profile-message');
        const profilePhotoUpload = document.getElementById('profile-photo-upload');
        const profilePhotoPreview = document.getElementById('profile-photo-preview');
        const profilePhotoPlusIcon = document.getElementById('profile-photo-plus-icon');


        // Buy Modal Elements
        const buyModal = document.getElementById('buyModal');
        const modalSkill = document.getElementById('modalSkill');
        const modalPrice = document.getElementById('modalPrice');
        const buyerNameInput = document.getElementById('buyerName');
        const buyerEmailInput = document.getElementById('buyerEmail');
        const buyerPhoneInput = document.getElementById('buyerPhone');
        const buyForm = document.getElementById('buyForm');
        const buyStatus = document.getElementById('buyStatus');
        const buyStatusMessage = document.getElementById('buyStatusMessage');
        const buyPayButton = document.getElementById('buyPayButton');

        // Sell Modal Elements
        const sellModal = document.getElementById('sellModal');
        const sellSkillNameInput = document.getElementById('sellSkillName');
        const sellPriceInput = document.getElementById('sellPrice');
        const sellDescriptionInput = document.getElementById('sellDescription');
        const sellForm = document.getElementById('sellForm');
        const sellStatus = document.getElementById('sellStatus');
        const sellStatusMessage = document.getElementById('sellStatusMessage');
        const sellSubmitButton = document.getElementById('sellSubmitButton');

        // Order Modal Elements
        const orderModal = document.getElementById('orderModal');
        const orderSkillNeededInput = document.getElementById('orderSkillNeeded');
        const orderDesiredPriceInput = document.getElementById('orderDesiredPrice');
        const orderSkillProviderInput = document.getElementById('orderSkillProvider');
        const orderRequirementsInput = document.getElementById('orderRequirements');
        const orderForm = document.getElementById('orderForm');
        const orderStatus = document.getElementById('orderStatus');
        const orderStatusMessage = document.getElementById('orderStatusMessage');
        const orderSubmitButton = document.getElementById('orderSubmitButton');

        // --- Three.js Scene Setup (for welcome page) ---
        let scene, camera, renderer, particles;
        const particleCount = 5000;
        const objects = []; // Array to store particle data

        function initThreeJS() {
            // Scene
            scene = new THREE.Scene();
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5; // Move camera back a bit
            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: bgCanvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            // --- Particle Creation ---
            const geometry = new THREE.BoxGeometry(0.02, 0.02, 0.02); // Small cube shape
            const material = new THREE.MeshBasicMaterial({ color: 0xcccccc }); 
            particles = new THREE.InstancedMesh(geometry, material, particleCount);
            
            // Create data for each particle (instance)
            for (let i = 0; i < particleCount; i++) {
                objects.push({
                    position: new THREE.Vector3(
                        (Math.random() - 0.5) * 10,
                        (Math.random() - 0.5) * 10,
                        (Math.random() - 0.5) * 10
                    ),
                    velocityFactor: 0.0005 + Math.random() * 0.001 // Random speed for each particle
                });
            }
            scene.add(particles);
            animateThreeJS(); // Start the animation loop
        }

        // --- Three.js Animation Loop ---
        function animateThreeJS() {
            requestAnimationFrame(animateThreeJS);
            const dummy = new THREE.Object3D(); // Dummy object to apply transformations
            const convergencePoint = new THREE.Vector3(0, 0, 0); // Center of the scene
            
            // Update each particle's position
            for (let i = 0; i < particleCount; i++) {
                const particleData = objects[i];
                const particlePosition = particleData.position;
                
                // Move particle towards the center
                const direction = new THREE.Vector3().subVectors(convergencePoint, particlePosition).normalize();
                particlePosition.add(direction.multiplyScalar(particleData.velocityFactor));
                
                // If particle is very close to the center, reset its position
                if (particlePosition.length() < 0.1) {
                    particlePosition.set(
                        (Math.random() - 0.5) * 10,
                        (Math.random() - 0.5) * 10,
                        (Math.random() - 0.5) * 10
                    );
                }
                // Update the dummy object's position and rotation
                dummy.position.copy(particlePosition);
                dummy.rotation.x += 0.01;
                dummy.rotation.y += 0.01;
                dummy.updateMatrix();
                // Apply the transformation to the instanced mesh
                particles.setMatrixAt(i, dummy.matrix);
            }
            particles.instanceMatrix.needsUpdate = true; // Tell three.js to update the instances
            // Render the scene
            renderer.render(scene, camera);
        }

        // --- Handle Window Resize for Three.js ---
        function onWindowResizeThreeJS() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }
        window.addEventListener('resize', onWindowResizeThreeJS, false);


        // --- LocalStorage Functions ---
        /**
         * Loads application data from localStorage.
         */
        function loadData() {
            const storedData = localStorage.getItem('skitionAppData');
            if (storedData) {
                appData = JSON.parse(storedData);
            } else {
                // Initialize with dummy data if no data is found
                appData = {
                    users: [
                        { phone: '0912345678', password: 'password123', fullName: 'John Doe', email: 'john.doe@example.com', profilePhoto: '', portfolioUrl: 'https://johndoe.com/portfolio' }
                    ],
                    marketplace: {
                        minters: [
                            { id: 'skill1', name: 'Dawit Tesfa', skill: 'Graphics Design', price: 15, hour: 2, portfolioUrl: 'https://dawittesfa.com' },
                            { id: 'skill2', name: 'Jane Smith', skill: 'Video Editing', price: 10, hour: 2, portfolioUrl: 'https://janesmith.dev' } 
                        ],
                        purchased: [
                            { id: 'purchase1', skill: 'Video Editing', price: 10, hour: 2, originalMinter: 'Jane Smith' },
                            { id: 'purchase2', skill: 'Photography', price: 20, hour: 3, originalMinter: 'Photographer X' },
                            { id: 'purchase3', skill: 'Copywriting', price: 5, hour: 1, originalMinter: 'Writer Y' },
                            { id: 'purchase4', skill: 'Social Media Mgmt', price: 30, hour: 4, originalMinter: 'Marketer Z' },
                            { id: 'purchase5', skill: 'Web Development', price: 50, hour: 5, originalMinter: 'Dev A' },
                            { id: 'purchase6', skill: 'Video Review', price: 10, hour: 2, originalMinter: 'Reviewer B' },
                            { id: 'purchase7', skill: 'Graphics Editing', price: 10, hour: 2, originalMinter: 'Designer C' },
                            { id: 'purchase8', skill: 'Photo Editing', price: 10, hour: 2, originalMinter: 'Editor D' }
                        ],
                        minted: [
                            { id: 'skill2', name: 'Jane Smith', skill: 'Video Editing', price: 10, hour: 2, status: 'Published' } // Example: Jane Smith minted Video Editing
                        ],
                        orders: [
                            { id: 'order1', skill: 'Web Development', price: 25, buyer: 'Jane Doe' },
                            { id: 'order2', skill: 'Mobile App Design', price: 40, buyer: 'John Smith' },
                            { id: 'order3', skill: 'UI/UX Research', price: 20, buyer: 'Emily White' },
                            { id: 'order4', skill: 'Content Creator', price: 10, buyer: 'Alex Johnson' }
                        ]
                    }
                };
            }
        }

        /**
         * Saves current application data to localStorage.
         */
        function saveData() {
            localStorage.setItem('skitionAppData', JSON.stringify(appData));
        }

        // --- Page Navigation ---
        /**
         * Shows a specific page and hides all others.
         * Manages visibility of the Three.js canvas and bottom navigation.
         * @param {string} pageId - The ID of the page to show.
         */
        function showPage(pageId) {
            PAGES.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            document.getElementById(pageId).classList.remove('hidden');

            if (pageId === 'welcome-page') {
                bgCanvas.classList.remove('hidden');
                bottomNav.classList.add('hidden');
            } else {
                bgCanvas.classList.add('hidden');
                if (currentUserPhone) { // Only show nav if logged in
                    bottomNav.classList.remove('hidden');
                } else {
                    bottomNav.classList.add('hidden');
                }
            }

            if (pageId === 'marketplace-page') {
                renderMarketplace();
            } else if (pageId === 'profile-page') {
                renderProfile();
            }
        }

        // --- Authentication Handlers ---
        /**
         * Handles the sign-in form submission.
         * @param {Event} event - The form submission event.
         */
        function handleSignIn(event) {
            event.preventDefault();
            const phone = signInPhoneInput.value.trim();
            const password = signInPasswordInput.value.trim();

            const user = appData.users.find(u => u.phone === phone && u.password === password);

            if (user) {
                currentUserPhone = phone;
                signInMessage.classList.add('hidden');
                showPage('marketplace-page');
            } else {
                signInMessage.textContent = 'Invalid phone number or password.';
                signInMessage.classList.remove('hidden');
            }
        }

        /**
         * Handles the sign-up form submission.
         * @param {Event} event - The form submission event.
         */
        function handleSignUp(event) {
            event.preventDefault();
            const phone = signUpPhoneInput.value.trim();
            const password = signUpPasswordInput.value.trim();
            const confirmPassword = signUpConfirmPasswordInput.value.trim();

            if (password !== confirmPassword) {
                signUpMessage.textContent = 'Passwords do not match.';
                signUpMessage.classList.remove('hidden');
                return;
            }

            if (appData.users.some(u => u.phone === phone)) {
                signUpMessage.textContent = 'Account with this phone number already exists.';
                signUpMessage.classList.remove('hidden');
                return;
            }

            appData.users.push({ phone, password, fullName: '', email: '', profilePhoto: '', portfolioUrl: '' }); // New user with empty profile
            saveData();
            signUpMessage.textContent = 'Account created successfully! Please sign in.';
            signUpMessage.classList.remove('hidden');
            signUpMessage.classList.remove('text-red-500');
            signUpMessage.classList.add('text-green-500');
            
            // Clear form and redirect to sign-in after a short delay
            setTimeout(() => {
                signUpPhoneInput.value = '';
                signUpPasswordInput.value = '';
                signUpConfirmPasswordInput.value = '';
                signUpMessage.classList.add('hidden');
                showPage('signin-page');
            }, 1500);
        }

        /**
         * Handles user logout.
         */
        function handleLogout() {
            currentUserPhone = null; // Clear current user
            bottomNav.classList.add('hidden'); // Hide bottom navigation
            showPage('signin-page'); // Redirect to sign-in page
        }

        // --- Marketplace Rendering ---
        /**
         * Renders the marketplace sections with data from appData.
         */
        function renderMarketplace() {
            // Clear existing content
            mintersList.innerHTML = '';
            purchasedList.innerHTML = '';
            mintedList.innerHTML = '';
            ordersList.innerHTML = '';

            // Render Minters
            appData.marketplace.minters.forEach(minter => {
                mintersList.innerHTML += `
                    <div class="space-y-3">
                        <p class="text-lg">${minter.name}</p>
                        <p class="text-gray-400">${minter.skill} ${minter.hour}hr</p>
                        <div class="flex flex-col items-start space-y-2 sm:flex-row sm:items-center sm:justify-between sm:space-y-0">
                            <span class="text-lg font-semibold">$${minter.price}</span>
                            <button class="bg-white text-black px-6 py-1 lg:px-8 lg:py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="openBuyModal('${minter.skill}', ${minter.price}, '${minter.name}')">Buy</button>
                        </div>
                        ${minter.portfolioUrl ? `<p class="text-sm text-gray-500 mt-2">Portfolio: <a href="${minter.portfolioUrl}" target="_blank" class="text-blue-400 hover:underline">${minter.portfolioUrl}</a></p>` : ''}
                    </div>
                `;
            });

            // Render Purchased
            appData.marketplace.purchased.forEach(item => {
                purchasedList.innerHTML += `
                    <div class="space-y-3">
                        <p class="text-lg">Your Owned</p>
                        <p class="text-gray-400">${item.skill} ${item.hour}hr</p>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between sm:space-y-0 space-y-2 items-start">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold">$${item.price}</span>
                                <button class="bg-black text-white px-6 py-1 lg:px-8 lg:py-2 rounded-md font-semibold border border-white hover:bg-white hover:text-black" onclick="openSellModal('${item.skill}', ${item.price})">Sell</button>
                            </div>
                            <button class="bg-white text-black px-6 py-1 lg:px-8 lg:py-2 rounded-md font-semibold border border-white hover:bg-gray-200" onclick="openOrderModal('${item.skill}', ${item.price}, '${item.originalMinter}')">Order</button>
                        </div>
                    </div>
                `;
            });

            // Render Minted
            const currentUser = appData.users.find(u => u.phone === currentUserPhone);
            const userFullName = currentUser ? currentUser.fullName : ''; // Get current user's full name

            const userMintedSkills = appData.marketplace.minted.filter(item => item.name === userFullName);

            if (userMintedSkills.length === 0) {
                mintedList.innerHTML = `<p class="text-gray-500 col-span-2">No skills minted yet. Go to Profile to mint one!</p>`;
            } else {
                userMintedSkills.forEach(item => {
                    mintedList.innerHTML += `
                        <div class="space-y-3">
                            <p class="text-lg">You Minted</p>
                            <p class="text-gray-400">${item.skill} ${item.hour}hr</p>
                            <div class="flex flex-col items-start space-y-2 sm:flex-row sm:items-center sm:justify-between sm:space-y-0">
                                <span class="text-lg font-semibold">$${item.price}</span>
                                ${item.status === 'Published' ? 
                                    `<button class="bg-white text-black px-6 py-1 lg:px-8 lg:py-2 rounded-md font-semibold border border-white hover:bg-gray-200">Published</button>
                                    <button class="bg-black text-white px-6 py-1 lg:px-8 lg:py-2 rounded-md font-semibold border border-white hover:bg-white hover:text-black" onclick="cancelMintedSkill('${item.id}')">Cancel</button>` :
                                    `<button class="bg-gray-700 text-gray-400 px-6 py-1 lg:px-8 lg:py-2 rounded-md font-semibold cursor-not-allowed">${item.status}</button>`
                                }
                            </div>
                        </div>
                    `;
                });
            }


            // Render Orders (assuming orders are for the current user's minted skills)
            const receivedOrders = appData.marketplace.orders.filter(order => {
                // Check if the order's skill provider matches any of the current user's minted skills
                return appData.marketplace.minted.some(mintedSkill => 
                    mintedSkill.skill === order.skill && mintedSkill.name === userFullName
                );
            });

            if (receivedOrders.length === 0) {
                ordersList.innerHTML = `<p class="text-gray-500 col-span-full">No incoming orders yet.</p>`;
            } else {
                receivedOrders.forEach(order => {
                    ordersList.innerHTML += `
                        <div class="space-y-3 p-4 border border-gray-700 rounded-md">
                            <p class="text-lg font-semibold">Skill: ${order.skill}</p>
                            <p class="text-gray-400">Price: $${order.price}</p>
                            <p class="text-gray-400">Bought by: ${order.buyer}</p>
                        </div>
                    `;
                });
            }
        }

        // --- Profile Rendering ---
        /**
         * Renders the profile page with current user's data.
         */
        function renderProfile() {
            const currentUser = appData.users.find(u => u.phone === currentUserPhone);
            if (currentUser) {
                profileFullNameInput.value = currentUser.fullName || '';
                profilePhoneInput.value = currentUser.phone; // Phone is read-only
                profileEmailInput.value = currentUser.email || '';
                profilePortfolioUrlInput.value = currentUser.portfolioUrl || ''; // Pre-fill portfolio URL

                // Display profile photo
                if (currentUser.profilePhoto) {
                    profilePhotoPreview.src = currentUser.profilePhoto;
                    profilePhotoPreview.classList.remove('hidden');
                    profilePhotoPlusIcon.classList.add('hidden'); // Hide plus icon if photo exists
                } else {
                    profilePhotoPreview.src = '';
                    profilePhotoPreview.classList.add('hidden');
                    profilePhotoPlusIcon.classList.remove('hidden'); // Show plus icon if no photo
                    profilePhotoPlusIcon.textContent = '+'; // Ensure plus icon content is correct
                }
            }
            
            // Clear previous messages
            profileMessage.classList.add('hidden');
            profileMessage.textContent = '';
        }

        /**
         * Handles minting a new skill from the profile page.
         * @param {Event} event - The form submission event.
         */
        function handleMintSkill(event) {
            event.preventDefault();
            const fullName = profileFullNameInput.value.trim();
            const email = profileEmailInput.value.trim();
            const skill = profileSkillInput.value.trim();
            const price = parseFloat(profileSkillPriceInput.value.trim());
            const hour = parseFloat(profileSkillHourInput.value.trim());
            const portfolioUrl = profilePortfolioUrlInput.value.trim();

            if (!fullName || !email || !skill || isNaN(price) || isNaN(hour)) {
                profileMessage.textContent = 'Please fill in all required fields (Full Name, Email, Skill, Price, Hour).';
                profileMessage.classList.remove('hidden', 'text-green-500');
                profileMessage.classList.add('text-red-500');
                return;
            }

            // Update current user's profile info
            const currentUser = appData.users.find(u => u.phone === currentUserPhone);
            if (currentUser) {
                currentUser.fullName = fullName;
                currentUser.email = email;
                currentUser.portfolioUrl = portfolioUrl; // Save portfolio URL to user data
            }

            const newSkillId = 'skill' + Date.now(); // Simple unique ID based on timestamp

            const newMintedSkill = {
                id: newSkillId,
                name: fullName, // Minter's full name
                skill: skill,
                price: price,
                hour: hour,
                status: 'Published' 
            };

            const newMinterSkill = {
                id: newSkillId,
                name: fullName,
                skill: skill,
                price: price,
                hour: hour,
                portfolioUrl: portfolioUrl // Add portfolio URL to minter data
            };

            appData.marketplace.minted.push(newMintedSkill);
            appData.marketplace.minters.push(newMinterSkill); // Add to general minters list
            saveData();

            profileMessage.textContent = `Skill "${skill}" minted successfully!`;
            profileMessage.classList.remove('hidden', 'text-red-500');
            profileMessage.classList.add('text-green-500');

            // Optionally clear skill-specific form fields after successful minting
            profileSkillInput.value = '';
            profileSkillPriceInput.value = '';
            profileSkillHourInput.value = '';
            profilePortfolioUrlInput.value = '';

            renderMarketplace(); // Re-render marketplace to show new minted skill
        }

        /**
         * Handles canceling a published skill.
         * @param {string} skillId - The ID of the skill to cancel.
         */
        function cancelMintedSkill(skillId) {
            // Find and remove from minted list
            const initialMintedLength = appData.marketplace.minted.length;
            appData.marketplace.minted = appData.marketplace.minted.filter(skill => skill.id !== skillId);
            const removedFromMinted = initialMintedLength > appData.marketplace.minted.length;

            // Find and remove from minters list
            const initialMintersLength = appData.marketplace.minters.length;
            appData.marketplace.minters = appData.marketplace.minters.filter(skill => skill.id !== skillId);
            const removedFromMinters = initialMintersLength > appData.marketplace.minters.length;

            if (removedFromMinted || removedFromMinters) {
                saveData();
                renderMarketplace(); // Re-render to update UI
                // Optionally show a message (can use profileMessage for this)
                profileMessage.textContent = 'Skill cancelled successfully!';
                profileMessage.classList.remove('hidden', 'text-red-500');
                profileMessage.classList.add('text-green-500');
                setTimeout(() => profileMessage.classList.add('hidden'), 2000);
            } else {
                profileMessage.textContent = 'Error: Skill not found or already cancelled.';
                profileMessage.classList.remove('hidden', 'text-green-500');
                profileMessage.classList.add('text-red-500');
                setTimeout(() => profileMessage.classList.add('hidden'), 2000);
            }
        }

        // --- Profile Photo Upload Handler ---
        profilePhotoUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profilePhotoPreview.src = e.target.result;
                    profilePhotoPreview.classList.remove('hidden');
                    profilePhotoPlusIcon.classList.add('hidden'); // Hide plus icon when image is loaded

                    // Save to current user's profile
                    const currentUser = appData.users.find(u => u.phone === currentUserPhone);
                    if (currentUser) {
                        currentUser.profilePhoto = e.target.result;
                        saveData();
                        profileMessage.textContent = 'Profile photo updated!';
                        profileMessage.classList.remove('hidden', 'text-red-500');
                        profileMessage.classList.add('text-green-500');
                        setTimeout(() => profileMessage.classList.add('hidden'), 2000);
                    }
                };
                reader.readAsDataURL(file);
            }
        });


        // --- Buy Modal Functions ---
        /**
         * Opens the buy modal and populates it with the selected skill and price.
         * @param {string} skill - The name of the skill being purchased.
         * @param {number} price - The price of the skill.
         * @param {string} minterName - The name of the minter.
         */
        function openBuyModal(skill, price, minterName) {
            // Store minterName temporarily for buy process
            buyModal.dataset.minterName = minterName; 

            // Reset form and status
            buyForm.classList.remove('hidden');
            buyStatus.classList.add('hidden');
            buyStatusMessage.textContent = '';
            buyPayButton.disabled = false;
            buyPayButton.textContent = 'Pay with Chapa';
            buyerNameInput.value = '';
            buyerEmailInput.value = '';
            buyerPhoneInput.value = '';

            // Set skill and price in the modal
            modalSkill.textContent = skill;
            modalPrice.textContent = price;

            // Show the modal
            buyModal.classList.add('show');
        }

        /**
         * Closes the buy modal.
         */
        function closeBuyModal() {
            buyModal.classList.remove('show');
            buyModal.dataset.minterName = ''; // Clear stored minter name
        }

        /**
         * Simulates the payment process with Chapa.
         */
        function processBuyPayment() {
            const name = buyerNameInput.value.trim();
            const email = buyerEmailInput.value.trim();
            const phone = buyerPhoneInput.value.trim();
            const skill = modalSkill.textContent;
            const price = parseFloat(modalPrice.textContent);
            const minterName = buyModal.dataset.minterName; // Retrieve minter name

            if (!name || !email || !phone) {
                buyStatusMessage.textContent = 'Please enter your name, email, and phone number.';
                buyStatusMessage.classList.remove('text-green-400', 'text-red-400');
                buyStatusMessage.classList.add('text-yellow-400');
                buyForm.classList.add('hidden');
                buyStatus.classList.remove('hidden');
                document.getElementById('closeBuyStatusButton').classList.remove('hidden');
                return;
            }

            // Disable button and show loading
            buyPayButton.disabled = true;
            buyPayButton.textContent = 'Processing...';
            buyStatusMessage.textContent = 'Redirecting to Chapa for payment...';
            buyStatusMessage.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
            buyStatusMessage.classList.add('text-gray-400');
            buyForm.classList.add('hidden');
            buyStatus.classList.remove('hidden');
            document.getElementById('closeBuyStatusButton').classList.add('hidden');

            // Simulate Chapa redirection and payment success after a delay
            setTimeout(() => {
                buyStatusMessage.textContent = 'Payment successful! Your purchase is complete.';
                buyStatusMessage.classList.remove('text-gray-400', 'text-yellow-400');
                buyStatusMessage.classList.add('text-green-400');
                document.getElementById('closeBuyStatusButton').classList.remove('hidden');
                buyPayButton.disabled = false;
                buyPayButton.textContent = 'Pay with Chapa';

                // Add to purchased items (assuming a fixed hour for simplicity)
                const newPurchase = {
                    id: 'p' + Date.now(), // Unique ID
                    skill: skill,
                    price: price,
                    hour: 2, // Default hour for purchased items
                    originalMinter: minterName // Store the original minter
                };
                appData.marketplace.purchased.push(newPurchase);

                // Add to orders (as if the minter received an order)
                const newOrder = {
                    id: 'o' + Date.now(), // Unique ID
                    skill: skill,
                    price: price,
                    buyer: name // Buyer's name
                };
                appData.marketplace.orders.push(newOrder);

                saveData();
                renderMarketplace(); // Re-render marketplace to show updated lists
            }, 2000);
        }

        // --- Sell Modal Functions ---
        /**
         * Opens the sell modal and pre-fills if data is available.
         * @param {string} [skillName=''] - Optional: The name of the skill to pre-fill.
         * @param {number} [price=''] - Optional: The price to pre-fill.
         */
        function openSellModal(skillName = '', price = '') {
            sellForm.classList.remove('hidden');
            sellStatus.classList.add('hidden');
            sellStatusMessage.textContent = '';
            sellSubmitButton.disabled = false;
            sellSubmitButton.textContent = 'List for Sale';
            sellSkillNameInput.value = skillName;
            sellPriceInput.value = price;
            sellDescriptionInput.value = ''; // Clear description

            sellModal.classList.add('show');
        }

        /**
         * Closes the sell modal.
         */
        function closeSellModal() {
            sellModal.classList.remove('show');
        }

        /**
         * Simulates the process of listing a skill for sale.
         */
        function processSell() {
            const skillName = sellSkillNameInput.value.trim();
            const price = sellPriceInput.value.trim();
            const description = sellDescriptionInput.value.trim();

            if (!skillName || !price) {
                sellStatusMessage.textContent = 'Please enter a skill name and price.';
                sellStatusMessage.classList.remove('text-green-400', 'text-red-400');
                sellStatusMessage.classList.add('text-yellow-400');
                sellForm.classList.add('hidden');
                sellStatus.classList.remove('hidden');
                document.getElementById('closeSellStatusButton').classList.remove('hidden');
                return;
            }

            sellSubmitButton.disabled = true;
            sellSubmitButton.textContent = 'Listing...';
            sellStatusMessage.textContent = 'Listing your skill for sale...';
            sellStatusMessage.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
            sellStatusMessage.classList.add('text-gray-400');
            sellForm.classList.add('hidden');
            sellStatus.classList.remove('hidden');
            document.getElementById('closeSellStatusButton').classList.add('hidden');

            setTimeout(() => {
                sellStatusMessage.textContent = `"${skillName}" listed for $${price} successfully!`;
                sellStatusMessage.classList.remove('text-gray-400', 'text-yellow-400');
                sellStatusMessage.classList.add('text-green-400');
                document.getElementById('closeSellStatusButton').classList.remove('hidden');
                sellSubmitButton.disabled = false;
                sellSubmitButton.textContent = 'List for Sale';

                // In a real app, this would involve moving from 'purchased' to 'minted'
                // For now, we'll just add to minted skills (assuming current user is the minter)
                const currentUser = appData.users.find(u => u.phone === currentUserPhone);
                const newMintedSkill = {
                    id: 'mt' + Date.now(), // Unique ID
                    name: currentUser.fullName || 'You', // Representing the current user
                    skill: skillName,
                    price: parseFloat(price),
                    hour: 2, // Default hour for minted skills
                    status: 'Published'
                };
                appData.marketplace.minted.push(newMintedSkill);
                
                // Also add to minters list so others can buy it
                const newMinterSkill = {
                    id: newMintedSkill.id, // Same ID to link them
                    name: currentUser.fullName || 'You',
                    skill: skillName,
                    price: parseFloat(price),
                    hour: 2,
                    portfolioUrl: currentUser.portfolioUrl || '' // Include portfolio URL
                };
                appData.marketplace.minters.push(newMinterSkill);

                saveData();
                renderMarketplace(); // Re-render marketplace
            }, 2000);
        }

        // --- Order Modal Functions ---
        /**
         * Opens the order modal and pre-fills details for a purchased skill.
         * @param {string} skillNeeded - The name of the skill being ordered.
         * @param {number} desiredPrice - The price of the skill.
         * @param {string} minterName - The name of the original minter/provider.
         */
        function openOrderModal(skillNeeded, desiredPrice, minterName) {
            orderForm.classList.remove('hidden');
            orderStatus.classList.add('hidden');
            orderStatusMessage.textContent = '';
            orderSubmitButton.disabled = false;
            orderSubmitButton.textContent = 'Place Order';
            orderRequirementsInput.value = ''; // Clear requirements

            // Pre-fill and make read-only
            orderSkillNeededInput.value = skillNeeded;
            orderSkillNeededInput.readOnly = true;
            orderSkillNeededInput.classList.add('bg-gray-700', 'cursor-not-allowed');

            orderDesiredPriceInput.value = desiredPrice;
            orderDesiredPriceInput.readOnly = true;
            orderDesiredPriceInput.classList.add('bg-gray-700', 'cursor-not-allowed');

            orderSkillProviderInput.value = minterName;
            orderSkillProviderInput.readOnly = true;
            orderSkillProviderInput.classList.add('bg-gray-700', 'cursor-not-allowed');

            orderModal.classList.add('show');
        }

        /**
         * Closes the order modal.
         */
        function closeOrderModal() {
            orderModal.classList.remove('show');
            // Reset read-only state and styling when closing
            orderSkillNeededInput.readOnly = false;
            orderSkillNeededInput.classList.remove('bg-gray-700', 'cursor-not-allowed');
            orderDesiredPriceInput.readOnly = false;
            orderDesiredPriceInput.classList.remove('bg-gray-700', 'cursor-not-allowed');
            orderSkillProviderInput.readOnly = false;
            orderSkillProviderInput.classList.remove('bg-gray-700', 'cursor-not-allowed');
        }

        /**
         * Simulates the process of placing a custom order.
         */
        function processOrder() {
            const skillNeeded = orderSkillNeededInput.value.trim();
            const desiredPrice = orderDesiredPriceInput.value.trim();
            const skillProvider = orderSkillProviderInput.value.trim();
            const requirements = orderRequirementsInput.value.trim();

            if (!skillNeeded || !desiredPrice || !skillProvider) {
                orderStatusMessage.textContent = 'Error: Missing order details. Please close and try again.';
                orderStatusMessage.classList.remove('text-green-400', 'text-yellow-400');
                orderStatusMessage.classList.add('text-red-400');
                orderForm.classList.add('hidden');
                orderStatus.classList.remove('hidden');
                document.getElementById('closeOrderStatusButton').classList.remove('hidden');
                return;
            }

            orderSubmitButton.disabled = true;
            orderSubmitButton.textContent = 'Placing...';
            orderStatusMessage.textContent = `Sending your order for "${skillNeeded}" to ${skillProvider}...`;
            orderStatusMessage.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
            orderStatusMessage.classList.add('text-gray-400');
            orderForm.classList.add('hidden');
            orderStatus.classList.remove('hidden');
            document.getElementById('closeOrderStatusButton').classList.add('hidden');

            setTimeout(() => {
                orderStatusMessage.textContent = `Your order for "${skillNeeded}" has been sent to ${skillProvider} successfully!`;
                orderStatusMessage.classList.remove('text-gray-400', 'text-yellow-400');
                orderStatusMessage.classList.add('text-green-400');
                document.getElementById('closeOrderStatusButton').classList.remove('hidden');
                orderSubmitButton.disabled = false;
                orderSubmitButton.textContent = 'Place Order';

                // In a real app, this would add to the minter's 'orders' list
                // For this simulation, we'll just confirm it was "sent".
                // If you want to see it appear in the 'Orders' section for the *current user*,
                // you'd need a more complex user management system.
            }, 2000);
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initThreeJS(); // Initialize Three.js background
            showPage('welcome-page'); // Start on the welcome page
        });
    </script>
</body>
</html>
